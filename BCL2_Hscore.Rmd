---
title: "BCL2 H-score"
author: "Jin Roh"
date: "2018년 9월 23일"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
options(scipen = 999)
```

```{r}
# Library
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lubridate)
library(survival)
library(survminer)
library(survMisc)
library(pROC)
theme_set(theme_pubr())
library(ber)
library(rms)
library(readr)
library(readxl)
library(ROCR)
library(stringr)
```


```{r}
# Nuclei data
df.1 <- read_csv("D:/Study/BCL2 IHC/QuantResult/DataNuc/DLBCL1_Nuclei.csv",
                 col_names = TRUE)
df.2 <- read_csv("D:/Study/BCL2 IHC/QuantResult/DataNuc/DLBCL2_Nuclei.csv",
                 col_names = TRUE)
df.3 <- read_csv("D:/Study/BCL2 IHC/QuantResult/DataNuc/Set1_Nuclei.csv",
                 col_names = TRUE)
df.4 <- read_csv("D:/Study/BCL2 IHC/QuantResult/DataNuc/result_Nuclei.csv",
                 skip = 1, col_names = TRUE)
```

```{r}
# Open image data
img.1 <- read_csv("D:/Study/BCL2 IHC/QuantResult/ImageData/DLBCL1_Image.csv",
                 col_names = TRUE)
img.2 <- read_csv("D:/Study/BCL2 IHC/QuantResult/ImageData/DLBCL2_Image.csv",
                 col_names = TRUE)
img.3 <- read_csv("D:/Study/BCL2 IHC/QuantResult/ImageData/Set1_Image.csv",
                 col_names = TRUE)
img.4 <- read_csv("D:/Study/BCL2 IHC/QuantResult/ImageData/result_Image.csv",
                 col_names = TRUE)
```

Calculate H-score

1. Rbind image datas  
2. Extract SN (surgical number) using "FileName_Raw"  
3. Aggregate percentages according to the SN (Function : Mean)
4. Calculate H-score
5. Open and rbind medical datas (AMC and Ajou)
6. Merge cell datas and medical datas  
7. Survival analysis

```{r}
# 1. Rbind image datas
df.img <- rbind(img.1, img.2, img.3, img.4)

# remove row number 490 (thumbnail file)
df.img <- df.img[-490,]
```

```{r}
# 2. Extract SN (surgical number) using "FileName_Raw"
SN <- "([A-Z0-9]+)[-.]([0-9]+)"
SN <- str_extract(df.img$FileName_Raw, SN)

df.img$SN <- SN
```

```{r}
# 3. Aggregate percentages accoridng to the SN (Function : Mean)
NegPct <- aggregate(Classify_Negative_PctObjectsPerBin ~ SN,
                    data = df.img, FUN = mean)
WeakPct <- aggregate(Classify_Weak_PctObjectsPerBin ~ SN,
                     data = df.img, FUN = mean)
ModPct <- aggregate(Classify_Moderate_PctObjectsPerBin ~ SN,
                    data = df.img, FUN = mean)
StrPct <- aggregate(Classify_Strong_PctObjectsPerBin ~ SN,
                    data = df.img, FUN = mean)

df.pct <- inner_join(NegPct, WeakPct, by = "SN")
df.pct <- inner_join(df.pct, ModPct, by = "SN")
df.pct <- inner_join(df.pct, StrPct, by = "SN")
```

```{r}
# 4. Calculate H-score
df.pct$Hscore <- (1 * df.pct$Classify_Weak_PctObjectsPerBin) +
        (2 * df.pct$Classify_Moderate_PctObjectsPerBin) +
        (3 * df.pct$Classify_Strong_PctObjectsPerBin)
```

```{r}
# 5. Open and rbind medical datas (AMC and Ajou)
# 5-1. AMC medical data
# open medical data
med.07_09 <- read_excel("D:/Study/MYC analysis/clinical07_09_2.xlsx", sheet = 1, col_names = TRUE)
med.10_12 <- read_excel("D:/Study/MYC analysis/clinical10_12_2.xlsx", sheet = 1, col_names = TRUE)

# cleansing the clinical data
med.amc <- rbind(med.07_09, med.10_12)
med.amc$Site <- gsub("Stomcah", "Stomach", med.amc$Site)
med.amc <- dplyr::filter(med.amc, Site != "Brain")
#med.data <- dplyr::filter(med.data, Site != "Stomach")
med.amc <- dplyr::filter(med.amc, Tx.regimen %in% c("R-CHOP", "R-CVP"))
med.amc[which(duplicated(med.amc$ID) == TRUE),]

med.amc$OS[which(med.amc$OS == 9)] <- 0
med.amc$Event[which(med.amc$Event == 9)] <- 0
med.amc$yr5.OS[which(med.amc$yr5.OS == 9)] <- 0
med.amc$yr2.Event[which(med.amc$yr2.Event == 9)] <- 0

# OS duration / EFS duration
med.amc$Dx.Date <- ymd(med.amc$Dx.Date)
med.amc$yr5.Last.Date <- ymd(med.amc$yr5.Last.Date)
med.amc$yr2.Event.Date <- ymd(med.amc$yr2.Event.Date)
med.amc$Event.Date <- ymd(med.amc$Event.Date)
med.amc$Last.Date <- ymd(med.amc$Last.Date)
med.amc$CR.Date <- ymd(med.amc$CR.Date)

mon.os <- as.period(interval(med.amc$Dx.Date, med.amc$Last.Date), unit = "months")
med.amc$mon.os <- mon.os%/% months(1)
mon.efs <- as.period(interval(med.amc$Dx.Date, med.amc$Event.Date), unit = "months")
med.amc$mon.efs <- mon.efs%/% months(1)
mon.5yr.os <- as.period(interval(med.amc$Dx.Date, med.amc$yr5.Last.Date), unit = "months")
med.amc$mon.5yr.os <- mon.5yr.os %/% months(1)
mon.2yr.efs <- as.period(interval(med.amc$Dx.Date, med.amc$yr2.Event.Date), unit = "months")
med.amc$mon.2yr.efs <- mon.2yr.efs %/% months(1)

# 5-2. Ajou medical data
ajou.med <- read_excel("D:/Study/BCL2/clinical_ajou_180316.xlsx", sheet = 1, col_names = TRUE)

ajou.med$Dx.Date <- ymd(ajou.med$Dx.Date)
ajou.med$yr2.Event.Date <- ymd(ajou.med$yr2.Event.Date)
ajou.med$Event.Date <- ymd(ajou.med$Event.Date)
ajou.med$Last.Date <- ymd(ajou.med$Last.Date)

mon.os <- as.period(interval(ajou.med$Dx.Date, ajou.med$Last.Date), unit = "months")
ajou.med$mon.os <- mon.os %/% months(1)
mon.efs <- as.period(interval(ajou.med$Dx.Date, ajou.med$Event.Date), unit = "months")
ajou.med$mon.efs <- mon.efs %/% months(1)
mon.2yr.efs <- as.period(interval(ajou.med$Dx.Date, ajou.med$yr2.Event.Date), unit = "months")
ajou.med$mon.2yr.efs <- mon.2yr.efs %/% months(1)

med.amc <- dplyr::select(med.amc, c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 13, 14,
                                    15, 16, 17, 18, 19, 20, 21, 22, 24,
                                    25, 29, 27, 32, 31, 33, 34, 36, 37,
                                    39))

med.data <- rbind(med.amc, ajou.med)
```

```{r}
# 6. Merge cell data and medical data
df <- inner_join(df.pct, med.data, by = "SN")
```

```{r}
# 7. Survival analysis
# 7-1. cox 
summary(coxph(Surv(mon.os, OS == 1) ~ Hscore, data = df))
```

```{r}
# 7-2. Find optimal cut point using ROC curve 
pred.bcl2.os <- prediction(df$Hscore, df$OS)
roc.bcl2.os <- performance(pred.bcl2.os, measure = "tpr", x.measure = "fpr")
plot(roc.bcl2.os)
abline(a = 0, b = 1)
```

```{r}
opt.cut <- function(perf, pred){
        cut.ind <- mapply(FUN = function(x, y, p){
                d = (x-0)^2 + (y-1)^2
                ind = which(d == min(d))
                c(sensitivity = y[[ind]], specificity = 1-x[[ind]],
                  cutoff = p[[ind]])
        }, perf@x.values, perf@y.values, pred@cutoffs)
}
print(opt.cut(roc.bcl2.os, pred.bcl2.os))

# cutoff 162.0986361
```

```{r}
# 7-3. Classify patients according to the optimal cut point
df <- dplyr::mutate(df, 
                    HscoreGr2 = ifelse(Hscore < 162, 0, 1))
```

```{r}
fit <- survfit(Surv(mon.os, OS == 1) ~ HscoreGr2, data = df)

g <- ggsurvplot(fit,
                surv.plot.height = 0.8,
                pval = TRUE, pval.size = 4,
                xlab = "Time (month)", font.x = 12,
                ylab = "OS", font.y = 12,
                risk.table = TRUE, risk.table.height = 0.35,
                risk.table.fontsize = 3.5,
                risk.table.y.text.col = FALSE,
                legend = "right",
                legend.title = "BCL2 H-score",
                legend.labs = c("Low", "High"),
                palette = c("blue", "red"))

g$table <- g$table +
        theme(plot.title = element_text(hjust = 0))

print(g)
```

```{r}
jpeg(filename = "D:/Study/BCL2/bcl2 figure/Bcl2HscoreOS.jpg")
print(g)
dev.off()
```

```{r}
fit <- survfit(Surv(mon.2yr.efs, yr2.Event == 1) ~ HscoreGr2, data = df)

g <- ggsurvplot(fit,
                surv.plot.height = 0.8,
                pval = TRUE, pval.size = 4,
                xlab = "Time (month)", font.x = 12,
                ylab = "2yr EFS", font.y = 12,
                risk.table = TRUE, risk.table.height = 0.35,
                risk.table.fontsize = 3.5,
                risk.table.y.text.col = FALSE,
                legend = "right",
                legend.title = "BCL2 H-score",
                legend.labs = c("Low", "High"),
                palette = c("blue", "red"))

g$table <- g$table +
        theme(plot.title = element_text(hjust = 0))

print(g)
```

```{r}
jpeg(filename = "D:/Study/BCL2/bcl2 figure/Bcl2HscoreEFS.jpg")
print(g)
dev.off()
```


Compare conventional method vs H-score

1. Classify patients as 4 groups using 10, 50, 90th percentile  
2. Compare survival curves between H-score 4 groups    
3. Classify patients as 2 groups using conventional method (50% proportion)  
4. Compare survival curves between conventional groups
5. Drawing ROC groups and compare  

```{r}
# 1. Classify patients as 4 groups using 10, 50, 90th percentile
# 26.24371 / 124.27153 / 272.64951
df <- dplyr::mutate(df, 
                    HscoreGr4 = ifelse(Hscore < 26,1,
                                       ifelse(Hscore >= 26 & Hscore < 124,2,
                                              ifelse(Hscore > 272, 4, 3))))
```

```{r}
# 2. Compare survival curves between H-score 4 groups 
fit <- survfit(Surv(mon.os, OS == 1) ~ HscoreGr4, data = df)

g <- ggsurvplot(fit,
                surv.plot.height = 0.8,
                pval = FALSE,
                xlab = "Time (month)", font.x = 12,
                ylab = "OS", font.y = 12,
                risk.table = TRUE, risk.table.height = 0.35,
                risk.table.fontsize = 3.5,
                risk.table.y.text.col = FALSE,
                legend = "bottom",
                legend.title = "BCL2 H-score",
                legend.labs = c("<10th Q", ">=10th Q & <50th Q",
                                ">=50th Q & <90th Q", ">90th Q"),
                palette = c("blue", "green", "yellow", "red"))

g$table <- g$table +
        theme(plot.title = element_text(hjust = 0))

print(g)
```

```{r}
jpeg(filename = "D:/Study/BCL2/bcl2 figure/Bcl2HscoreOS4gr.jpg")
print(g)
dev.off()
```


```{r}
# 3. Classify patients as 2 groups using conventional method (50% proportion)
df$PctConv <- df$Classify_Moderate_PctObjectsPerBin +
        df$Classify_Strong_PctObjectsPerBin +
        df$Classify_Weak_PctObjectsPerBin

df <- dplyr::mutate(df, ConvGr = ifelse(PctConv > 50, 1, 0))
```

```{r}
# 4. Compare survival curves between conventional groups
fit <- survfit(Surv(mon.os, OS == 1) ~ ConvGr, data = df)

g <- ggsurvplot(fit,
                surv.plot.height = 0.8,
                pval = TRUE, pval.size = 4,
                xlab = "Time (month)", font.x = 12,
                ylab = "OS", font.y = 12,
                risk.table = TRUE, risk.table.height = 0.35,
                risk.table.fontsize = 3.5,
                risk.table.y.text.col = FALSE,
                legend = "right",
                legend.title = "BCL2",
                legend.labs = c("Low(<50%)", "High(>50%)"),
                palette = c("blue", "red"))

g$table <- g$table +
        theme(plot.title = element_text(hjust = 0))

print(g)
```

```{r}
jpeg(filename = "D:/Study/BCL2/bcl2 figure/Bcl2ConvOS.jpg")
print(g)
dev.off()
```

```{r}
fit <- survfit(Surv(mon.2yr.efs, yr2.Event == 1) ~ ConvGr, data = df)

g <- ggsurvplot(fit,
                surv.plot.height = 0.8,
                pval = TRUE, pval.size = 4,
                xlab = "Time (month)", font.x = 12,
                ylab = "2yr EFS", font.y = 12,
                risk.table = TRUE, risk.table.height = 0.35,
                risk.table.fontsize = 3.5,
                risk.table.y.text.col = FALSE,
                legend = "right",
                legend.title = "BCL2",
                legend.labs = c("Low(<50%)", "High(>50%)"),
                palette = c("blue", "red"))

g$table <- g$table +
        theme(plot.title = element_text(hjust = 0))

print(g)
```

```{r}
jpeg(filename = "D:/Study/BCL2/bcl2 figure/Bcl2ConvEFS.jpg")
print(g)
dev.off()
```

```{r}
# 5. Drawing ROC groups and compare
# 5-1. ROC curve
pred.Hscore <- prediction(df$Hscore, df$OS)
pred.Conv <- prediction(df$ConvGr, df$OS)
roc.Hscore <- performance(pred.Hscore, measure = "tpr", x.measure = "fpr")
roc.Conv <- performance(pred.Conv, measure = "tpr", x.measure = "fpr")
plot(roc.Hscore, col = "red")
plot(roc.Conv, add = "TRUE", col = "blue")
abline(a = 0, b = 1)
```

```{r}
jpeg(filename = "D:/Study/BCL2/bcl2 figure/ROCcomp2.jpg")
plot(roc.Hscore, col = "red")
plot(roc.Conv, add = "TRUE", col = "blue")
abline(a = 0, b = 1)
dev.off()
```

```{r}
# 5-2. Calculate AUROC
auc.Hscore <- performance(pred.Hscore, measure = "auc")
auc.Hscore@y.values
# Hscore AUC 0.6161616
```

```{r}
auc.Conv <- performance(pred.Conv, measure = "auc")
auc.Conv@y.values
# 0.538961
```











































